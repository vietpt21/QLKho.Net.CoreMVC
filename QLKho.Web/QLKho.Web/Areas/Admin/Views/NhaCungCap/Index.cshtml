@{
    Layout = "~/Views/Shared/_Layout_Admin.cshtml";
}

﻿<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">

                <h4 class="card-title">Datatable Editable</h4>
                <div class="d-flex justify-content-end mb-3">
                    <button id="addNhaCungCapBtn" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="table-responsive">
                    <table id="tblDataNhaCungCap" class="table table-editable table-nowrap align-middle table-edits" ">
                        <thead>
                            <tr>
                                <th>Ma Nha Cung Cap </th>
                                <th>Ten Nha Cung Cap</th>
                                <th>Edit</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div> <!-- end col -->
</div> <!-- end row -->

<script src="@Url.Content("~/assets/libs/jquery/jquery.min.js")"></script>


<div class="modal fade" id="addNhaCungCapModal" tabindex="-1" role="dialog" aria-labelledby="addNhaCungCapModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addNhaCungCapModalLabel">Add New Nha Cung Cap</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addNhaCungCapForm">
                    <div class="form-group">
                        <label for="TenNhaCungCap">Tên Nhà Cung Cấp</label>
                        <input type="text" class="form-control" id="TenNhaCungCap" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Thêm Nhà Cung Cấp</button>
                </form>

            </div>
        </div>
    </div>
</div>


<script>
    $(document).ready(function () {
        var table; // Variable to store DataTable instance

        // Initialize DataTable and load data via AJAX
        $.ajax({
            url: '/api/NhaCungCapApi',
            method: 'GET',
            success: function (response) {
                var data = response; // Assuming response is already an array of CongTy objects

                // Generate HTML based on data
                var html = '';
                data.forEach(function (item) {
                    html += '<tr data-id="' + item.Id + '">' +
                        '<td data-field="Id">' + item.Id + '</td>' +
                        '<td data-field="TenNhaCungCap">' + item.TenNhaCungCap + '</td>' +
                        '<td>' +
                        '<a class="btn btn-outline-secondary btn-sm edit" title="Edit">' +
                        '<i class="fas fa-pencil-alt"></i>' +
                        '</a>' +
                        '<a class="btn btn-outline-danger btn-sm delete" title="Delete">' +
                        '<i class="fas fa-trash-alt"></i>' +
                        '</a>' +
                        '</td>' +
                        '</tr>';
                });

                // Add HTML to the table body
                $('#tblDataNhaCungCap tbody').html(html);

                // Initialize DataTables
                table = $('#tblDataNhaCungCap').DataTable({
                    // DataTables configuration options
                });

                // Handle inline editing
                $('#tblDataNhaCungCap tbody').on('click', '.edit', function () {
                    var $btn = $(this).find('i');
                    var $row = $(this).closest('tr');
                    var id = $row.data('id');

                    if ($btn.hasClass('fa-pencil-alt')) {
                        // Fetch data for the specific row
                        $.ajax({
                            url: '/api/NhaCungCapApi/' + id,
                            method: 'GET',
                            success: function (response) {
                                var item = response;

                                // Populate the row with the fetched data and make it editable
                                $row.find('td[data-field="TenNhaCungCap"]').html('<input type="text" class="form-control" value="' + item.TenNhaCungCap + '">');
                                // Switch to save mode
                                $btn.removeClass('fa-pencil-alt').addClass('fa-save').attr('title', 'Save');
                            },
                            error: function (xhr, status, error) {
                                console.error('Error fetching data:', error);
                            }
                        });
                    } else {
                        // Switch to edit mode and save data
                        var updatedData = {
                            Id: id, // Add Id to the data object
                            TenNhaCungCap: $row.find('input').val(),
                        };

                        $.ajax({
                            url: '/api/NhaCungCapApi/' + id,
                            method: 'PUT',
                            contentType: 'application/json',
                            data: JSON.stringify(updatedData),
                            success: function (response) {
                                console.log('Update successful:', response);
                                // Optionally, update the row data with response data
                                $btn.removeClass('fa-save').addClass('fa-pencil-alt').attr('title', 'Edit');
                            },
                            error: function (xhr, status, error) {
                                console.error('Error updating data:', error);
                                // Handle error response
                            }
                        });
                    }
                });

                // Handle deletion
                $('#tblDataNhaCungCap tbody').on('click', '.delete', function () {
                    var $row = $(this).closest('tr');
                    var id = $row.data('id');

                    if (confirm('Are you sure you want to delete this item?')) {
                        $.ajax({
                            url: '/api/NhaCungCapApi/' + id,
                            method: 'DELETE',
                            success: function (response) {
                                console.log('Deletion successful');
                                table.row($row).remove().draw();
                            },
                            error: function (xhr, status, error) {
                                console.error('Error deleting data:', error);
                                // Handle error response
                            }
                        });
                    }
                });

                // Handle form submission for adding a new line
                $('#addNhaCungCapForm').on('submit', function (e) {
                    e.preventDefault();

                    var newNhaCungCap = {
                        TenNhaCungCap: $('#TenNhaCungCap').val(),
                    };

                    $.ajax({
                        url: '/api/NhaCungCapApi',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(newNhaCungCap),
                        success: function (response) {
                            console.log('Thêm thành công');
                            var item = response;

                            // Thêm dòng mới vào DataTable
                            var newRowHtml = '<tr data-id="' + item.Id + '">' +
                                '<td data-field="Id">' + item.Id + '</td>' +
                                '<td data-field="TenNhaCungCap">' + item.TenNhaCungCap + '</td>' +
                                '<td>' +
                                '<a class="btn btn-outline-secondary btn-sm edit" title="Edit">' +
                                '<i class="fas fa-pencil-alt"></i>' +
                                '</a>' +
                                '<a class="btn btn-outline-danger btn-sm delete" title="Delete">' +
                                '<i class="fas fa-trash-alt"></i>' +
                                '</a>' +
                                '</td>' +
                                '</tr>';
                            table.row.add($(newRowHtml)).draw();

                            // Đóng modal và làm sạch form
                            $('#addNhaCungCapModal').modal('hide');
                            $('#addNhaCungCapForm')[0].reset();
                        },
                        error: function (xhr, status, error) {
                            console.error('Lỗi khi thêm dữ liệu:', error);
                            // Xử lý phản hồi lỗi
                        }
                    });
                });


            },
            error: function (xhr, status, error) {
                console.error('Error fetching data:', error);
            }
        });

        $('#addNhaCungCapBtn').on('click', function () {
            $('#addNhaCungCapModal').modal('show');
        });
    });
</script>

<style>
    .editable {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
    }
</style>
